<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--NewPage-->
<HTML>
<HEAD>
<!-- Generated by javadoc (build 1.6.0_23) on Thu Jul 12 03:11:11 CEST 2012 -->
<TITLE>
RoleChanger
</TITLE>

<META NAME="date" CONTENT="2012-07-12">

<LINK REL ="stylesheet" TYPE="text/css" HREF="../../../../stylesheet.css" TITLE="Style">

<SCRIPT type="text/javascript">
function windowTitle()
{
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="RoleChanger";
    }
}
</SCRIPT>
<NOSCRIPT>
</NOSCRIPT>

</HEAD>

<BODY BGCOLOR="white" onload="windowTitle();">
<HR>


<!-- ========= START OF TOP NAVBAR ======= -->
<A NAME="navbar_top"><!-- --></A>
<A HREF="#skip-navbar_top" title="Skip navigation links"></A>
<TABLE BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0" SUMMARY="">
<TR>
<TD COLSPAN=2 BGCOLOR="#EEEEFF" CLASS="NavBarCell1">
<A NAME="navbar_top_firstrow"><!-- --></A>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="3" SUMMARY="">
  <TR ALIGN="center" VALIGN="top">
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../overview-summary.html"><FONT CLASS="NavBarFont1"><B>Overview</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-summary.html"><FONT CLASS="NavBarFont1"><B>Package</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#FFFFFF" CLASS="NavBarCell1Rev"> &nbsp;<FONT CLASS="NavBarFont1Rev"><B>Class</B></FONT>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="class-use/RoleChanger.html"><FONT CLASS="NavBarFont1"><B>Use</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-tree.html"><FONT CLASS="NavBarFont1"><B>Tree</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../deprecated-list.html"><FONT CLASS="NavBarFont1"><B>Deprecated</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../index-files/index-1.html"><FONT CLASS="NavBarFont1"><B>Index</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../help-doc.html"><FONT CLASS="NavBarFont1"><B>Help</B></FONT></A>&nbsp;</TD>
  </TR>
</TABLE>
</TD>
<TD ALIGN="right" VALIGN="top" ROWSPAN=3><EM>
</EM>
</TD>
</TR>

<TR>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
&nbsp;<A HREF="../../../../net/floodlightcontroller/core/internal/OpenflowPipelineFactory.html" title="class in net.floodlightcontroller.core.internal"><B>PREV CLASS</B></A>&nbsp;
&nbsp;<A HREF="../../../../net/floodlightcontroller/core/internal/RoleChangerTest.html" title="class in net.floodlightcontroller.core.internal"><B>NEXT CLASS</B></A></FONT></TD>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
  <A HREF="../../../../index.html?net/floodlightcontroller/core/internal/RoleChanger.html" target="_top"><B>FRAMES</B></A>  &nbsp;
&nbsp;<A HREF="RoleChanger.html" target="_top"><B>NO FRAMES</B></A>  &nbsp;
&nbsp;<SCRIPT type="text/javascript">
  <!--
  if(window==top) {
    document.writeln('<A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>');
  }
  //-->
</SCRIPT>
<NOSCRIPT>
  <A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>
</NOSCRIPT>


</FONT></TD>
</TR>
<TR>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
  SUMMARY:&nbsp;NESTED&nbsp;|&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
DETAIL:&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
</TR>
</TABLE>
<A NAME="skip-navbar_top"></A>
<!-- ========= END OF TOP NAVBAR ========= -->

<HR>
<!-- ======== START OF CLASS DATA ======== -->
<H2>
<FONT SIZE="-1">
net.floodlightcontroller.core.internal</FONT>
<BR>
Class RoleChanger</H2>
<PRE>
java.lang.Object
  <IMG SRC="../../../../resources/inherit.gif" ALT="extended by "><B>net.floodlightcontroller.core.internal.RoleChanger</B>
</PRE>
<HR>
<DL>
<DT><PRE>public class <B>RoleChanger</B><DT>extends java.lang.Object</DL>
</PRE>

<P>
This class handles sending of RoleRequest messages to all connected switches.
 
 Handling Role Requests is tricky. Roles are hard state on the switch and
 we can't query it so we need to make sure that we have consistent states
 on the switches. Whenever we send a role request to the set of connected 
 switches we need to make sure that we've sent the request to all of them 
 before we process the next change request. If a new switch connects, we 
 need to send it the current role and need to make sure that the current
 role doesn't change while we are doing it. We achieve this by synchronizing
 all these actions on Controller.roleChanger
 On the receive side: we need to make sure that we receive a reply for each 
 request we send and that the reply is consistent with the request we sent. 
 We'd also like to send the role request to the switch asynchronously in a
 separate thread so we don't block the REST API or other callers.
 
 There are potential ways to relax these sychrnonization requirements:
 - "Generation ID" for each role request. However, this would be most useful
   if it were global for the whole cluster
 - Regularly resend the controller's current role. Don't know whether this
   might have adverse effects on the switch. 
   
 Caveats:
 - No way to know if another controller (not in our controller cluster) 
   sends MASTER requests to connected switches. Then we would drop to
   slave role without knowing it. Could regularly resend the current role. 
   Ideally the switch would notify us if it demoted us. What happens if
   the other controller also regularly resends the same role request? 
   Or if the health check determines that
   a controller is dead but the controller is still talking to switches (maybe
   just its health check failed) and resending the master role request.... 
   We could try to detect if a switch demoted us to slave even if we think
   we are master (error messages on packet outs, e.g., when sending LLDPs)
 

 The general model of Role Request handling is as follows:
 
 - All role request messages are handled by this class. Class Controller 
   submits a role change request and the request gets queued. submitRequest
   takes a Collection of switches to which to send the request. We make a copy
   of this list. 
 - A thread takes these change requests from the queue and sends them to 
   all the switches (using our copy of the switch list). 
 - The OFSwitchImpl sends the request over the wire and puts the request
   into a queue of pending request (storing xid and role). We start a timeout 
   to make sure we eventually receive a reply from the switch. We use a single
   timeout for each request submitted using submitRequest()
 - After the timeout triggers we go over the list of switches again and
   check that a response has been received (by checking the head of the 
   OFSwitchImpl's queue of pending requests)
 - We handle requests and timeouts in the same thread. We use a priority queue
   to schedule them so we are guaranteed that they are processed in 
   the same order as they are submitted. If a request times out we drop
   the connection to this switch. 
 - Since we decouple submission of role change requests and actually sending
   them we cannot check a received role reply against the controller's current 
   role because the controller's current role could have changed again. 
 - Receiving Role Reply messages is handled by OFChannelHandler and
   OFSwitchImpl directly. The OFSwitchImpl checks if the received request 
   is as expected (xid and role match the head of the pending queue in 
   OFSwitchImpl). If so
   the switch updates its role. Otherwise the connection is dropped. If this
   is the first reply, the SWITCH_SUPPORTS_NX_ROLE attribute is set.
   Next, we call addSwitch(), removeSwitch() to update the list of active
   switches if appropriate.
 - If we receive an Error indicating that roles are not supported by the 
   switch, we set the SWITCH_SUPPORTS_NX_ROLE to false. We keep the 
   switch connection alive while in MASTER and EQUAL role. 
   (TODO: is this the right behavior for EQUAL??). If the role changes to
   SLAVE the switch connection is dropped (remember: only if the switch
   doesn't support role requests)  
   The expected behavior is that the switch will probably try to reconnect
   repeatedly (with some sort of exponential backoff), but after a  while 
   will give-up and move on to the next controller-IP configured on the 
   switch. This is the serial failover mechanism from OpenFlow spec v1.0.
   
 New switch connection:
 - Switch handshake is done without sending any role request messages.
 - After handshake completes, switch is added to the list of connected switches
   and we send the first role request message if role
   requests are enabled. If roles are disabled automatically promote switch to
   active switch list and clear FlowTable.
 - When we receive the first reply we proceed as above. In addition, if
   the role request is for MASTER we wipe the flow table. We do not wipe
   the flow table if the switch connected while role supported was disabled
   on the controller.
<P>

<P>
<HR>

<P>

<!-- ======== CONSTRUCTOR SUMMARY ======== -->

<A NAME="constructor_summary"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="2"><FONT SIZE="+2">
<B>Constructor Summary</B></FONT></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD><CODE><B><A HREF="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#RoleChanger()">RoleChanger</A></B>()</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD>
</TR>
</TABLE>
&nbsp;
<!-- ========== METHOD SUMMARY =========== -->

<A NAME="method_summary"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="2"><FONT SIZE="+2">
<B>Method Summary</B></FONT></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>&nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#submitRequest(java.util.Collection, net.floodlightcontroller.core.IFloodlightProviderService.Role)">submitRequest</A></B>(java.util.Collection&lt;<A HREF="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</A>&gt;&nbsp;switches,
              <A HREF="../../../../net/floodlightcontroller/core/IFloodlightProviderService.Role.html" title="enum in net.floodlightcontroller.core">IFloodlightProviderService.Role</A>&nbsp;role)</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD>
</TR>
</TABLE>
&nbsp;<A NAME="methods_inherited_from_class_java.lang.Object"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#EEEEFF" CLASS="TableSubHeadingColor">
<TH ALIGN="left"><B>Methods inherited from class java.lang.Object</B></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD><CODE>equals, getClass, hashCode, notify, notifyAll, toString, wait, wait, wait</CODE></TD>
</TR>
</TABLE>
&nbsp;
<P>

<!-- ========= CONSTRUCTOR DETAIL ======== -->

<A NAME="constructor_detail"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="1"><FONT SIZE="+2">
<B>Constructor Detail</B></FONT></TH>
</TR>
</TABLE>

<A NAME="RoleChanger()"><!-- --></A><H3>
RoleChanger</H3>
<PRE>
public <B>RoleChanger</B>()</PRE>
<DL>
</DL>

<!-- ============ METHOD DETAIL ========== -->

<A NAME="method_detail"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="1"><FONT SIZE="+2">
<B>Method Detail</B></FONT></TH>
</TR>
</TABLE>

<A NAME="submitRequest(java.util.Collection, net.floodlightcontroller.core.IFloodlightProviderService.Role)"><!-- --></A><H3>
submitRequest</H3>
<PRE>
public void <B>submitRequest</B>(java.util.Collection&lt;<A HREF="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</A>&gt;&nbsp;switches,
                          <A HREF="../../../../net/floodlightcontroller/core/IFloodlightProviderService.Role.html" title="enum in net.floodlightcontroller.core">IFloodlightProviderService.Role</A>&nbsp;role)</PRE>
<DL>
<DD><DL>
</DL>
</DD>
</DL>
<!-- ========= END OF CLASS DATA ========= -->
<HR>


<!-- ======= START OF BOTTOM NAVBAR ====== -->
<A NAME="navbar_bottom"><!-- --></A>
<A HREF="#skip-navbar_bottom" title="Skip navigation links"></A>
<TABLE BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0" SUMMARY="">
<TR>
<TD COLSPAN=2 BGCOLOR="#EEEEFF" CLASS="NavBarCell1">
<A NAME="navbar_bottom_firstrow"><!-- --></A>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="3" SUMMARY="">
  <TR ALIGN="center" VALIGN="top">
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../overview-summary.html"><FONT CLASS="NavBarFont1"><B>Overview</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-summary.html"><FONT CLASS="NavBarFont1"><B>Package</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#FFFFFF" CLASS="NavBarCell1Rev"> &nbsp;<FONT CLASS="NavBarFont1Rev"><B>Class</B></FONT>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="class-use/RoleChanger.html"><FONT CLASS="NavBarFont1"><B>Use</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-tree.html"><FONT CLASS="NavBarFont1"><B>Tree</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../deprecated-list.html"><FONT CLASS="NavBarFont1"><B>Deprecated</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../index-files/index-1.html"><FONT CLASS="NavBarFont1"><B>Index</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../../help-doc.html"><FONT CLASS="NavBarFont1"><B>Help</B></FONT></A>&nbsp;</TD>
  </TR>
</TABLE>
</TD>
<TD ALIGN="right" VALIGN="top" ROWSPAN=3><EM>
</EM>
</TD>
</TR>

<TR>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
&nbsp;<A HREF="../../../../net/floodlightcontroller/core/internal/OpenflowPipelineFactory.html" title="class in net.floodlightcontroller.core.internal"><B>PREV CLASS</B></A>&nbsp;
&nbsp;<A HREF="../../../../net/floodlightcontroller/core/internal/RoleChangerTest.html" title="class in net.floodlightcontroller.core.internal"><B>NEXT CLASS</B></A></FONT></TD>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
  <A HREF="../../../../index.html?net/floodlightcontroller/core/internal/RoleChanger.html" target="_top"><B>FRAMES</B></A>  &nbsp;
&nbsp;<A HREF="RoleChanger.html" target="_top"><B>NO FRAMES</B></A>  &nbsp;
&nbsp;<SCRIPT type="text/javascript">
  <!--
  if(window==top) {
    document.writeln('<A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>');
  }
  //-->
</SCRIPT>
<NOSCRIPT>
  <A HREF="../../../../allclasses-noframe.html"><B>All Classes</B></A>
</NOSCRIPT>


</FONT></TD>
</TR>
<TR>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
  SUMMARY:&nbsp;NESTED&nbsp;|&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
DETAIL:&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
</TR>
</TABLE>
<A NAME="skip-navbar_bottom"></A>
<!-- ======== END OF BOTTOM NAVBAR ======= -->

<HR>

</BODY>
</HTML>
